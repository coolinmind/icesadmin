/** layui-v2.4.2 MIT License By https://www.layui.com */
 ;!function(e,t){"function"==typeof define&&(define.amd||define.cmd)?define(t):"function"==typeof require&&"object"==typeof exports?module.exports=t(require,exports,module):window.layui&&layui.define?layui.define(["webuploader"],function(e){e("webupload",t(layui.jquery,layui.webuploader))}):e.icestpl=e.icestpl||t()}(this,function(e,t){function i(i,s){this.elem=e(i),this.options=e.extend({},this.elem.data(),s),this.wrap=e("#icesadmin-"+this.options.name),this.filepicker2=e("#icesadmin-"+this.options.name+"-filePicker2"),this.queue=e('<ul class="filelist"></ul>').appendTo(this.wrap.find(".queueList")),this.statusBar=this.wrap.find(".statusBar"),this.info=this.statusBar.find(".info"),this.upload=this.wrap.find(".uploadBtn"),this.placeHolder=this.wrap.find(".placeholder"),this.progress=this.statusBar.find(".progress").hide(),this.fileCount=0,this.fileSize=0,this.ratio=window.devicePixelRatio||1,this.thumbnailWidth=110*this.ratio,this.thumbnailHeight=110*this.ratio,this.state="pedding",this.percentages={},this.supportTransition=function(){var e=document.createElement("p").style,t="transition"in e||"WebkitTransition"in e||"MozTransition"in e||"msTransition"in e||"OTransition"in e;return e=null,t}();var a=this;return this.uploader=t.create(this.options),this.uploader.addButton({id:"#icesadmin-"+this.options.name+"-filePicker2",label:"继续添加"}),this.uploader.onUploadProgress=function(t,i){var s=e("#"+t.id),o=s.find(".progress span");o.css("width",100*i+"%"),a.percentages[t.id][1]=i,a.updateTotalProgress()},this.uploader.onFileQueued=function(e){a.fileCount++,a.fileSize+=e.size,1===a.fileCount&&(a.placeHolder.addClass("webuploader-element-invisible"),a.statusBar.show()),a.addFile(e),a.setState("ready"),a.updateTotalProgress()},this.uploader.onFileDequeued=function(e){a.fileCount--,a.fileSize-=e.size,a.fileCount||a.setState("pedding"),a.removeFile(e),a.updateTotalProgress()},this.uploader.on("uploadAccept",function(e,t,i){return e.file.serverUrl=t.file,"undefined"==typeof t.code||1==t.code||(i(t.msg),!1)}),this.uploader.on("all",function(e,t,i){switch(e){case"uploadFinished":a.setState("confirm");break;case"startUpload":a.setState("uploading");break;case"stopUpload":a.setState("paused")}}),this.uploader.onError=function(e){console.log(e)},this.upload.on("click",function(){return!e(this).hasClass("disabled")&&void("ready"===a.state?a.uploader.upload():"paused"===a.state?a.uploader.upload():"uploading"===a.state&&a.uploader.stop())}),this.info.on("click",".retry",function(e){e.preventDefault(),a.uploader.retry()}),this.upload.addClass("state-"+this.state),this.updateTotalProgress(),this}return i.prototype.addFile=function(t){var i=e('<li id="'+t.id+'"><p class="title">'+t.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),s=e('<div class="file-panel"><span class="layui-icon layui-icon-delete cancel" title="删除"></span><span class="layui-icon layui-icon-refresh-3 rotateLeft" title="向左旋转"></span><span class="layui-icon layui-icon-edit openMeitu" title="打开美图"></span></div>').appendTo(i),a=i.find("p.progress span"),o=i.find("p.imgWrap"),r=e('<p class="error"></p>'),n=this,l="",d=function(e){switch(e){case"exceed_size":l="文件大小超出";break;case"interrupt":l="上传暂停";break;default:l=e||"上传失败，请重试"}r.text(l).appendTo(i)};"invalid"===t.getStatus()?d(t.statusText):(o.text("预览中"),this.uploader.makeThumb(t,function(i,s){if(i)return void o.text("不能预览");var a=e('<img src="'+s+'" data-fancybox="" href="'+(t.serverUrl||s)+'">');o.empty().append(a)},this.thumbnailWidth,this.thumbnailHeight),this.percentages[t.id]=[t.size,0],t.rotation=0),t.on("statuschange",function(e,s){if("progress"===s&&a.hide().width(0),"error"===e||"invalid"===e)console.log(t.statusText),d(t.statusText),n.percentages[t.id][1]=1;else if("interrupt"===e)d("interrupt");else if("queued"===e)n.percentages[t.id][1]=0;else if("progress"===e)r.remove(),a.css("display","block");else if("complete"===e){if(t.serverUrl){var l=n.elem.find("input[name='"+n.options.name+"']").val();l=""==l?[]:l.split(","),l.push(t.serverUrl),n.elem.find("input[name='"+n.options.name+"']").val(l.join(","))}o.find("img").attr("href",t.serverUrl||o.find("img").attr("src")),i.append('<span class="layui-icon layui-icon-ok success"></span>')}i.removeClass("state-"+s).addClass("state-"+e)}),i.on("mouseenter",function(){s.stop().animate({height:30})}),i.on("mouseleave",function(){s.stop().animate({height:0})}),s.on("click","span",function(){var i,s=e(this).index();switch(s){case 0:return void n.uploader.removeFile(t);case 1:t.rotation+=90;break;case 2:}n.supportTransition?(i="rotate("+t.rotation+"deg)",o.css({"-webkit-transform":i,"-mos-transform":i,"-o-transform":i,transform:i})):o.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(t.rotation/90%4+4)%4+")")}),i.appendTo(this.queue)},i.prototype.removeFile=function(t){var i=e("#"+t.id);if(delete this.percentages[t.id],t.serverUrl){var s=this.elem.find("input[name='"+this.options.name+"']").val().split(","),a=[];for(var o in s)s[o]!=t.serverUrl&&""!=s[o]&&a.push(s[o]);this.elem.find("input[name='"+this.options.name+"']").val(a.join(","))}this.updateTotalProgress(),i.off().find(".file-panel").off().end().remove()},i.prototype.updateTotalProgress=function(){var t,i=0,s=0,a=this.progress.children();e.each(this.percentages,function(e,t){s+=t[0],i+=t[0]*t[1]}),t=s?i/s:0,a.eq(0).text(Math.round(100*t)+"%"),a.eq(1).css("width",Math.round(100*t)+"%"),this.updateStatus()},i.prototype.updateStatus=function(){var e,i="";"ready"===this.state?i="选中"+this.fileCount+"张图片，共"+t.formatSize(this.fileSize)+"。":"confirm"===this.state?(e=this.uploader.getStats(),e.uploadFailNum&&(i="已成功上传"+e.successNum+"个文件，"+e.uploadFailNum+'个文件上传失败，<a class="retry" style="color: blue;cursor: pointer">重新上传</a>失败图片')):(e=this.uploader.getStats(),i="共"+this.fileCount+"张（"+t.formatSize(this.fileSize)+"），已上传"+e.successNum+"张",e.uploadFailNum&&(i+="，失败"+e.uploadFailNum+"张")),this.info.html(i)},i.prototype.setState=function(e){var t;if(e!==this.state){switch(this.upload.removeClass("state-"+this.state),this.upload.addClass("state-"+e),this.state=e,this.state){case"pedding":this.placeHolder.removeClass("webuploader-element-invisible"),this.queue.parent().removeClass("filled"),this.queue.hide(),this.statusBar.addClass("webuploader-element-invisible"),this.uploader.refresh();break;case"ready":this.placeHolder.addClass("webuploader-element-invisible"),this.filepicker2.removeClass("webuploader-element-invisible"),this.queue.parent().addClass("filled"),this.queue.show(),this.statusBar.removeClass("webuploader-element-invisible"),this.uploader.refresh();break;case"uploading":this.filepicker2.addClass("webuploader-element-invisible"),this.progress.show(),this.upload.text("暂停上传");break;case"paused":this.progress.show(),this.upload.text("继续上传");break;case"confirm":if(this.progress.hide(),this.upload.text("开始上传").addClass("disabled"),t=this.uploader.getStats(),t.successNum&&!t.uploadFailNum)return void this.setState("finish");0==t.successNum&&0==t.uploadFailNum&&(this.filepicker2.removeClass("webuploader-element-invisible"),this.upload.text("开始上传").removeClass("disabled"));break;case"finish":t=this.uploader.getStats(),this.filepicker2.removeClass("webuploader-element-invisible"),this.upload.text("开始上传").removeClass("disabled"),t.successNum?layer.msg("上传成功"):(this.state="done",location.reload())}this.updateStatus()}},i.prototype.setInitFile=function(e){var i=new XMLHttpRequest,s=this;i.open("get",e,!0),i.responseType="blob",i.onload=function(){if(200==this.status){var i=new t.File(new t.Lib.File(e,this.response));i.serverUrl=e,s.uploader.addFile(i),i.setStatus("complete")}},i.send()},i});